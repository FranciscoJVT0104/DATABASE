// ===============================
//  CARGAR CSV EN LA TABLA
// ===============================
document.getElementById("importCSV").addEventListener("change", function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
        const text = event.target.result;
        cargarCSVEnTabla(text);
    };
    reader.readAsText(file, "UTF-8");
});

function cargarCSVEnTabla(csv) {
    const filas = csv.split("\n").map(f => f.split(","));
    const tbody = document.querySelector("#tablaDatos tbody");
    tbody.innerHTML = "";

    filas.forEach(fila => {
        if (fila.length < 8) return; // ahora 8 columnas
        const tr = document.createElement("tr");

        fila.forEach(celda => {
            const td = document.createElement("td");
            td.textContent = celda.trim();
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
}

// ===============================
//  LEER TABLA COMO OBJETOS
// ===============================
function obtenerDatosDeLaTabla() {
    const filas = document.querySelectorAll("#tablaDatos tbody tr");
    const data = [];

    filas.forEach(row => {
        const celdas = row.querySelectorAll("td");
        if (celdas.length >= 8) {
            data.push({
                APELLIDOS: celdas[0].textContent.trim(),
                NOMBRES: celdas[1].textContent.trim(),
                CURSO: celdas[2].textContent.trim(),
                DNI: celdas[3].textContent.trim(),
                CELULAR: celdas[4].textContent.trim(),
                FECHA: celdas[5].textContent.trim(),
                INFORME: celdas[6].textContent.trim(),
                OBS: celdas[7].textContent.trim()
            });
        }
    });

    return data;
}

// ===============================
//  EXPORTAR CSV UTF-8
// ===============================
function exportarCSV(nombre, encabezados, filas) {
    let contenido = encabezados.join(",") + "\n";

    filas.forEach(f => {
        contenido += f.join(",") + "\n";
    });

    const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = nombre + ".csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// =====================================================
//   EXPORTAR REV NOV
// =====================================================
document.getElementById("btnExportREV").addEventListener("click", function () {
    const datos = obtenerDatosDeLaTabla();

    const encabezados = [
        "username", "password", "firstname", "lastname",
        "email", "city", "course1", "group1", "obs"
    ];

    const filas = datos.map(d => [
        d.DNI,
        d.DNI + d.APELLIDOS.charAt(0),
        d.NOMBRES,
        d.APELLIDOS,
        d.DNI + "@gmail.com",
        "LIMA",
        d.CURSO,
        "A",
        d.OBS
    ]);

    exportarCSV("REV NOV", encabezados, filas);
});

// =====================================================
//   FILTRAR CELULARES ÃšNICOS PARA CONT NOV
// =====================================================
function filtrarCelularesUnicos(datos) {
    const vistos = new Set();
    const filtrados = [];

    datos.forEach(d => {
        if (!vistos.has(d.CELULAR)) {
            vistos.add(d.CELULAR);
            filtrados.push(d);
        }
    });

    return filtrados;
}

// =====================================================
//    EXPORTAR CONT NOV
// =====================================================
document.getElementById("btnExportCONT").addEventListener("click", function () {
    let datos = obtenerDatosDeLaTabla();

    // ðŸ”¥ eliminar nÃºmeros repetidos SOLO para CONT
    datos = filtrarCelularesUnicos(datos);

    const encabezados = [
        "Nombre", "Apellido", "Telefono", "correo electronico",
        "Direccion", "CumpleaÃ±os", "Observaciones"
    ];

    const filas = datos.map(d => [
        d.NOMBRES,
        d.APELLIDOS + " " + d.INFORME,
        d.CELULAR,
        d.CELULAR + "s@gmail.com",
        "ESTANDAR",
        d.FECHA,  // FECHA SE USA COMO CUMPLEAÃ‘OS
        d.OBS
    ]);

    exportarCSV("CONT NOV", encabezados, filas);
});
